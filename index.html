<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="生成画像からプロンプトを探せるビジュアル検索型プロンプト管理ツール">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ProStocker">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <title>Prompt Stocker</title>
    <link rel="stylesheet" href="style.css?v=2">
</head>

<body>
    <div class="app">
        <!-- ヘッダー -->
        <header class="header">
            <button id="menuBtn" class="header__menu-btn" aria-label="メニューを開く">☰</button>
            <h1 class="header__title">
                <span class="header__title-text">🗃️ Prompt Stocker</span>
                <span class="header__title-icon">🗃️</span>
            </h1>
            <div class="header__actions">
                <button id="mobileSearchBtn" class="header__search-btn" aria-label="検索を開く">🔍</button>
                <div class="search-box" id="searchBox">
                    <input type="text" id="searchInput" class="search-box__input" placeholder="プロンプトを検索...">
                </div>
                <button id="addBtn" class="btn btn--primary" aria-label="新規登録">
                    <span class="btn-icon">+</span>
                    <span class="btn-text"> 新規登録</span>
                </button>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="main">
            <div id="sidebarOverlay" class="sidebar-overlay"></div>
            <!-- サイドバー -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar__mobile-header">
                    <div class="sidebar__logo">🗃️ Prompt Stocker</div>
                    <button id="closeMenuBtn" class="sidebar__close-btn" aria-label="メニューを閉じる">×</button>
                </div>
                <nav class="sidebar__nav">
                    <h2 class="sidebar__title">カテゴリ</h2>
                    <ul class="category-list" id="categoryList">
                        <li class="category-list__item active" data-category="all">📁 すべて</li>
                        <li class="category-list__item" data-category="image">🖼️ 画像</li>
                        <li class="category-list__item" data-category="video">🎬 動画</li>
                        <li class="category-list__item" data-category="chat">💬 チャット</li>
                        <li class="category-list__item" data-category="code">💻 コーディング</li>
                        <li class="category-list__item" data-category="favorite">⭐ お気に入り</li>
                    </ul>
                </nav>

                <div class="sidebar__tags">
                    <h2 class="sidebar__title">タグ</h2>
                    <div class="tag-cloud" id="tagCloud">
                        <!-- タグが動的に追加される -->
                    </div>
                </div>

                <div class="sidebar__actions">
                    <button id="exportBtn" class="btn btn--secondary btn--small">📤 エクスポート</button>
                    <button id="importBtn" class="btn btn--secondary btn--small">📥 インポート</button>
                    <input type="file" id="importFile" accept=".json" hidden>
                </div>

                <div class="sidebar__settings">
                    <h2 class="sidebar__title">表示設定</h2>
                    <div class="setting-item checkbox-item">
                        <input type="checkbox" id="themeToggle">
                        <label for="themeToggle">☀️ ライトモード</label>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">カード高さ: <span id="heightValue">300px</span></label>
                        <input type="range" id="heightSlider" min="100" max="600" value="300" step="50">
                    </div>
                    <div class="setting-item checkbox-item">
                        <input type="checkbox" id="unlimitedHeight">
                        <label for="unlimitedHeight">上限なし（全表示）</label>
                    </div>
                    <div class="setting-item" style="margin-top: 16px;">
                        <button type="button" class="btn btn--secondary btn--small" id="openSettingsBtn">⚙️
                            API設定</button>
                    </div>
                </div>

                <div class="sidebar__footer">
                    <div class="sidebar__version">vv1.1.10</div>
                </div>
            </aside>

            <!-- ギャラリー -->
            <section class="gallery" id="gallery">
                <!-- プロンプトカードが動的に追加される -->
                <div class="gallery__empty" id="emptyState">
                    <p>プロンプトがまだありません</p>
                    <p>「+ 新規登録」から追加してください</p>
                </div>
            </section>
        </main>
    </div>

    <!-- 新規登録・編集モーダル -->
    <div class="modal" id="editModal">
        <div class="modal__backdrop"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h2 class="modal__title" id="modalTitle">新規プロンプト登録</h2>
                <button class="modal__close" id="closeModal" data-close-modal>&times;</button>
            </div>
            <form class="modal__body" id="promptForm">
                <input type="hidden" id="promptId">

                <div class="form-group">
                    <label for="promptTitle">タイトル</label>
                    <input type="text" id="promptTitle" class="form-control" placeholder="タイトルを入力（任意）">
                </div>

                <div class="form-group">
                    <label for="promptText">プロンプト</label>
                    <textarea id="promptText" class="form-control" rows="6" placeholder="プロンプトを入力..."
                        required></textarea>
                </div>

                <div class="form-group">
                    <label for="categorySelect">カテゴリ</label>
                    <select id="categorySelect" class="form-control" required>
                        <option value="image">🖼️ 画像</option>
                        <option value="video">🎬 動画</option>
                        <option value="chat">💬 チャット</option>
                        <option value="code">💻 コーディング</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tagsInput">タグ（カンマ区切り）</label>
                    <input type="text" id="tagsInput" class="form-control" placeholder="例: anime, portrait, sunset"
                        list="tagSuggestions">
                    <datalist id="tagSuggestions"></datalist>
                </div>

                <div class="form-group">
                    <label>画像</label>
                    <div class="image-upload" id="imageUpload">
                        <div class="image-upload__dropzone" id="dropzone">
                            <p>📸 画像をドラッグ&ドロップ</p>
                            <p>または</p>
                            <button type="button" class="btn btn--secondary" id="selectImageBtn">ファイルを選択</button>
                            <button type="button" class="btn btn--accent" id="generateImageBtn">✨ AIで画像を生成</button>
                            <input type="file" id="imageInput" accept="image/*" hidden>
                        </div>
                        <div id="apiKeyWarning" class="api-key-warning" hidden>
                            <span class="warning-icon">⚠️</span>
                            <span class="warning-text">APIキーが未設定です。「API設定」から登録してください。</span>
                        </div>
                        <div class="image-upload__generating" id="imageGenerating" hidden>
                            <div class="spinner"></div>
                            <p>🎨 AIが画像を生成中...</p>
                            <p class="small">数秒かかる場合があるで、そのまま待ってな</p>
                        </div>
                        <div class="image-upload__preview" id="imagePreview" hidden>
                            <img id="previewImg" src="" alt="プレビュー">
                            <button type="button" class="btn btn--danger btn--small" id="removeImageBtn">削除</button>
                        </div>
                    </div>
                </div>

                <div class="form-group form-group--inline">
                    <label class="checkbox-label">
                        <input type="checkbox" id="favoriteCheck">
                        ⭐ お気に入りに追加
                    </label>
                </div>

                <div class="modal__footer">
                    <button type="button" class="btn btn--secondary" id="cancelBtn">キャンセル</button>
                    <button type="submit" class="btn btn--primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 詳細表示モーダル -->
    <div class="modal" id="detailModal">
        <div class="modal__backdrop"></div>
        <div class="modal__content modal__content--large">
            <div class="modal__header">
                <h2 class="modal__title">プロンプト詳細</h2>
                <button class="modal__close" id="closeDetailModal">&times;</button>
            </div>
            <div class="modal__body">
                <div class="detail-view">
                    <div class="detail-view__image" id="detailImage">
                        <!-- 画像が表示される -->
                    </div>
                    <div class="detail-view__info">
                        <div class="detail-view__category" id="detailCategory"></div>
                        <div class="detail-view__prompt" id="detailPrompt"></div>
                        <div class="detail-view__tags" id="detailTags"></div>
                        <div class="detail-view__actions">
                            <button class="btn btn--primary" id="copyPromptBtn">📋 コピー</button>
                            <button class="btn btn--secondary" id="editPromptBtn">✏️ 編集</button>
                            <button class="btn btn--danger" id="deletePromptBtn">🗑️ 削除</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定モーダル -->
    <div class="modal" id="settingsModal">
        <div class="modal__backdrop"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h2>⚙️ 設定</h2>
                <button class="modal__close" data-close-modal>&times;</button>
            </div>
            <div class="modal__body" style="padding: 24px;">
                <div class="form-group">
                    <label>Gemini APIキー</label>
                    <p style="font-size: 0.8rem; color: var(--text-subdued); margin-bottom: 8px;">
                        画像生成機能を使用するにはAPIキーが必要です。
                        <a href="https://aistudio.google.com/app/apikey" target="_blank"
                            style="color: var(--brand-accent);">Google AI Studio</a>で取得できます。
                    </p>
                    <input type="password" id="apiKeyInput" class="form-control" placeholder="AIza...">
                </div>
                <div class="form-group">
                    <label>画像生成モデル</label>
                    <select id="aiModelSelect" class="form-control">
                        <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image (Nano Banana)</option>
                        <option value="gemini-3-pro-image-preview">Gemini 3 Pro Image (Nano Banana Pro)</option>
                    </select>
                    <p style="font-size: 0.75rem; color: var(--text-subdued); margin-top: 4px;">
                        ※ Flash (Nano Banana) は高速で安定しています。<br>
                        ※ Pro (Nano Banana Pro) は高品質ですが、アクセス制限がある場合があります。
                    </p>
                </div>
                <div class="form-group" style="display: flex; gap: 8px; align-items: center;">
                    <button type="button" class="btn btn--primary" id="saveApiKeyBtn">💾 保存</button>
                    <button type="button" class="btn btn--danger" id="clearApiKeyBtn">🗑️ 削除</button>
                    <span id="apiKeyStatus" class="api-key-status"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA更新通知バナー -->
    <div id="updateBanner" class="update-banner">
        <div class="update-banner__content">
            <span class="update-banner__icon">🚀</span>
            <span class="update-banner__text">新しいバージョンが利用可能です<span class="update-banner__changelog">:
                    更新内容が一言でわかる新機能を追加しました！🚀</span></span>
        </div>
        <div class="update-banner__actions">
            <button id="updateNowBtn" class="update-banner__btn">今すぐ更新</button>
            <button id="dismissUpdateBtn" class="update-banner__dismiss" aria-label="閉じる">&times;</button>
        </div>
    </div>

    <!-- トースト通知 -->
    <div class="toast" id="toast"></div>

    <script src="js/db.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
</body>

</html>